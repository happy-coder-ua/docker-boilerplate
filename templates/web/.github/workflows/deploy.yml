name: Deploy (reusable)

on:
  workflow_call:
    inputs:
      SERVER_HOST:
        required: true
        type: string
      SERVER_USER:
        required: true
        type: string
      PROJECT_PATH:
        required: true
        type: string
      PROJECT_NAME:
        required: true
        type: string
      DOMAIN_NAME:
        required: true
        type: string
      TRAEFIK_NETWORK:
        required: true
        type: string
    secrets:
      SSH_PRIVATE_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SERVER_HOST: ${{ inputs.SERVER_HOST }}
      SERVER_USER: ${{ inputs.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      PROJECT_PATH: ${{ inputs.PROJECT_PATH }}
      PROJECT_NAME: ${{ inputs.PROJECT_NAME }}
      DOMAIN_NAME: ${{ inputs.DOMAIN_NAME }}
      TRAEFIK_NETWORK: ${{ inputs.TRAEFIK_NETWORK }}
    steps:
      - name: Validate required secrets
        run: |
          set -euo pipefail
          missing=0
          for key in SERVER_HOST SERVER_USER SSH_PRIVATE_KEY PROJECT_PATH PROJECT_NAME DOMAIN_NAME TRAEFIK_NETWORK; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key" >&2
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            cd "$PROJECT_PATH"
            git pull origin main
            # Create/Update .env from secrets
            echo "PROJECT_NAME=$PROJECT_NAME" > .env
            echo "DOMAIN_NAME=$DOMAIN_NAME" >> .env
            echo "TRAEFIK_NETWORK=$TRAEFIK_NETWORK" >> .env

            docker compose up -d --build
            docker image prune -f
