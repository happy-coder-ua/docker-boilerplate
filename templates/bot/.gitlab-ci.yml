stages:
  - deploy

deploy:
  stage: deploy
  image: alpine:latest
  rules:
    - if: '$SERVER_HOST && $SERVER_USER && $SSH_PRIVATE_KEY && $PROJECT_PATH && $PROJECT_NAME && $BOT_TOKEN && $TRAEFIK_NETWORK && $REPO_URL'
      when: on_success
    - when: never
  before_script:
    - 'which ssh-agent || ( apk add --update openssh git docker-cli )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - |
      set -euo pipefail

      : "${SERVER_HOST:?SERVER_HOST is required}"
      : "${SERVER_USER:?SERVER_USER is required}"
      : "${SSH_PRIVATE_KEY:?SSH_PRIVATE_KEY is required}"
      : "${PROJECT_PATH:?PROJECT_PATH is required}"
      : "${PROJECT_NAME:?PROJECT_NAME is required}"
      : "${BOT_TOKEN:?BOT_TOKEN is required}"
      : "${TRAEFIK_NETWORK:?TRAEFIK_NETWORK is required}"
      : "${REPO_URL:?REPO_URL is required}"

      branch="${GIT_BRANCH:-${CI_COMMIT_BRANCH:-main}}"

      PROJECT_NAME_B64="$(printf '%s' "$PROJECT_NAME" | base64 | tr -d '\n')"
      BOT_TOKEN_B64="$(printf '%s' "$BOT_TOKEN" | base64 | tr -d '\n')"
      DOMAIN_NAME_B64="$(printf '%s' "${DOMAIN_NAME:-}" | base64 | tr -d '\n')"
      TRAEFIK_NETWORK_B64="$(printf '%s' "$TRAEFIK_NETWORK" | base64 | tr -d '\n')"
      TRAEFIK_ENTRYPOINT_B64="$(printf '%s' "${TRAEFIK_ENTRYPOINT:-}" | base64 | tr -d '\n')"
      TRAEFIK_ENABLE_B64="$(printf '%s' "${TRAEFIK_ENABLE:-}" | base64 | tr -d '\n')"
      REPO_URL_B64="$(printf '%s' "$REPO_URL" | base64 | tr -d '\n')"
      PROJECT_PATH_B64="$(printf '%s' "$PROJECT_PATH" | base64 | tr -d '\n')"
      BRANCH_B64="$(printf '%s' "$branch" | base64 | tr -d '\n')"

      REPO_SSH_KEY_B64=""
      if [ -n "${REPO_SSH_KEY:-}" ]; then
        REPO_SSH_KEY_B64="$(printf '%s' "$REPO_SSH_KEY" | base64 | tr -d '\n')"
      fi

      ssh "$SERVER_USER@$SERVER_HOST" \
        "PROJECT_NAME_B64='$PROJECT_NAME_B64' BOT_TOKEN_B64='$BOT_TOKEN_B64' DOMAIN_NAME_B64='$DOMAIN_NAME_B64' TRAEFIK_NETWORK_B64='$TRAEFIK_NETWORK_B64' TRAEFIK_ENTRYPOINT_B64='$TRAEFIK_ENTRYPOINT_B64' TRAEFIK_ENABLE_B64='$TRAEFIK_ENABLE_B64' REPO_URL_B64='$REPO_URL_B64' PROJECT_PATH_B64='$PROJECT_PATH_B64' BRANCH_B64='$BRANCH_B64' REPO_SSH_KEY_B64='$REPO_SSH_KEY_B64'" \
        'sh -s' <<'REMOTE'
      set -euo pipefail

      PROJECT_NAME="$(printf '%s' "$PROJECT_NAME_B64" | base64 -d)"
      BOT_TOKEN="$(printf '%s' "$BOT_TOKEN_B64" | base64 -d)"
      DOMAIN_NAME="$(printf '%s' "$DOMAIN_NAME_B64" | base64 -d)"
      TRAEFIK_NETWORK="$(printf '%s' "$TRAEFIK_NETWORK_B64" | base64 -d)"
      TRAEFIK_ENTRYPOINT="$(printf '%s' "$TRAEFIK_ENTRYPOINT_B64" | base64 -d)"
      TRAEFIK_ENABLE="$(printf '%s' "$TRAEFIK_ENABLE_B64" | base64 -d)"
      REPO_URL="$(printf '%s' "$REPO_URL_B64" | base64 -d)"
      PROJECT_PATH="$(printf '%s' "$PROJECT_PATH_B64" | base64 -d)"
      branch="$(printf '%s' "$BRANCH_B64" | base64 -d)"

      if ! command -v git >/dev/null 2>&1; then
        echo "git is not installed on the server" >&2
        exit 1
      fi

      if ! command -v docker >/dev/null 2>&1; then
        echo "docker is not installed on the server" >&2
        exit 1
      fi

      COMPOSE_BIN="docker compose"
      if ! docker compose version >/dev/null 2>&1; then
        if command -v docker-compose >/dev/null 2>&1; then
          COMPOSE_BIN="docker-compose"
        else
          echo "Docker Compose is not available (neither 'docker compose' nor 'docker-compose')" >&2
          exit 1
        fi
      fi

      clone_url="$REPO_URL"
      if [ -n "${REPO_SSH_KEY_B64:-}" ]; then
        mkdir -p "$HOME/.ssh"
        chmod 700 "$HOME/.ssh"
        key_path="$HOME/.ssh/repo_deploy_key"
        printf '%s' "$REPO_SSH_KEY_B64" | base64 -d > "$key_path"
        chmod 600 "$key_path"
        touch "$HOME/.ssh/known_hosts"
        chmod 600 "$HOME/.ssh/known_hosts"

        repo_host=""
        case "$REPO_URL" in
          git@*:* ) repo_host="$(printf '%s' "$REPO_URL" | awk -F'[@:]' '{print $2}')" ;;
          https://*/* ) repo_host="$(printf '%s' "$REPO_URL" | awk -F[/:] '{print $4}')" ;;
        esac
        if [ -n "$repo_host" ]; then
          if ! ssh-keygen -F "$repo_host" >/dev/null 2>&1; then
            ssh-keyscan -H "$repo_host" >> "$HOME/.ssh/known_hosts" 2>/dev/null || true
          fi
        fi

        export GIT_SSH_COMMAND="ssh -i $key_path -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes"

        if printf '%s' "$REPO_URL" | grep -q '^https\?://'; then
          repo_host="$(printf '%s' "$REPO_URL" | awk -F[/:] '{print $4}')"
          repo_path="$(printf '%s' "$REPO_URL" | sed -E 's#^https?://[^/]+/##')"
          repo_path="${repo_path%.git}"
          clone_url="git@${repo_host}:${repo_path}.git"
        fi
      fi

      if [ ! -d "$PROJECT_PATH" ]; then
        mkdir -p "$(dirname "$PROJECT_PATH")"
        git clone --branch "$branch" "$clone_url" "$PROJECT_PATH"
      fi

      if [ -d "$PROJECT_PATH" ] && [ ! -d "$PROJECT_PATH/.git" ]; then
        if [ -z "$(ls -A "$PROJECT_PATH" 2>/dev/null || true)" ]; then
          rmdir "$PROJECT_PATH" 2>/dev/null || true
          mkdir -p "$(dirname "$PROJECT_PATH")"
          git clone --branch "$branch" "$clone_url" "$PROJECT_PATH"
        else
          echo "Not a git repository: $PROJECT_PATH (missing .git)" >&2
          exit 1
        fi
      fi

      cd "$PROJECT_PATH"

      if [ ! -f docker-compose.yml ]; then
        echo "docker-compose.yml not found in $PROJECT_PATH" >&2
        exit 1
      fi

      git remote set-url origin "$clone_url" || true
      if ! git pull origin "$branch"; then
        echo "git pull failed. If this is a private repository, set REPO_SSH_KEY in GitLab CI variables." >&2
        exit 1
      fi

      if ! docker network inspect "$TRAEFIK_NETWORK" >/dev/null 2>&1; then
        echo "Traefik network '$TRAEFIK_NETWORK' does not exist on the server" >&2
        exit 1
      fi

      tmp="$(mktemp)"
      if [ -f .env ]; then
        grep -vE '^(PROJECT_NAME|BOT_TOKEN|DOMAIN_NAME|TRAEFIK_NETWORK|TRAEFIK_ENTRYPOINT|TRAEFIK_ENABLE)=' .env > "$tmp" || true
      fi

      : > .env
      printf '%s\n' "PROJECT_NAME=$PROJECT_NAME" >> .env
      printf '%s\n' "BOT_TOKEN=$BOT_TOKEN" >> .env
      if [ -n "$DOMAIN_NAME" ]; then printf '%s\n' "DOMAIN_NAME=$DOMAIN_NAME" >> .env; fi
      printf '%s\n' "TRAEFIK_NETWORK=$TRAEFIK_NETWORK" >> .env
      if [ -n "$TRAEFIK_ENTRYPOINT" ]; then
        printf '%s\n' "TRAEFIK_ENTRYPOINT=$TRAEFIK_ENTRYPOINT" >> .env
      fi
      if [ -n "$TRAEFIK_ENABLE" ]; then printf '%s\n' "TRAEFIK_ENABLE=$TRAEFIK_ENABLE" >> .env; fi
      if [ -s "$tmp" ]; then cat "$tmp" >> .env; fi
      rm -f "$tmp"

      $COMPOSE_BIN up -d --build
      docker image prune -f
      REMOTE
