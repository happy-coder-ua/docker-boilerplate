name: CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: secrets.SERVER_HOST != '' && secrets.SERVER_USER != '' && secrets.SSH_PRIVATE_KEY != '' && secrets.PROJECT_PATH != '' && secrets.PROJECT_NAME != '' && secrets.BOT_TOKEN != '' && secrets.TRAEFIK_NETWORK != ''
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
      PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
      TRAEFIK_NETWORK: ${{ secrets.TRAEFIK_NETWORK }}
      TRAEFIK_ENABLE: ${{ secrets.TRAEFIK_ENABLE }}
    steps:
      - name: Validate required secrets
        run: |
          set -euo pipefail
          missing=0
          for key in SERVER_HOST SERVER_USER SSH_PRIVATE_KEY PROJECT_PATH PROJECT_NAME BOT_TOKEN TRAEFIK_NETWORK; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key" >&2
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            cd "$PROJECT_PATH"
            git pull origin main
            # Create/Update .env from secrets
            echo "PROJECT_NAME=$PROJECT_NAME" > .env
            echo "BOT_TOKEN=$BOT_TOKEN" >> .env
            echo "DOMAIN_NAME=$DOMAIN_NAME" >> .env
            echo "TRAEFIK_NETWORK=$TRAEFIK_NETWORK" >> .env
            echo "TRAEFIK_ENABLE=$TRAEFIK_ENABLE" >> .env
            
            docker compose up -d --build
            docker image prune -f
