name: CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: >-
      ${{
        secrets.SERVER_HOST != '' &&
        secrets.SERVER_USER != '' &&
        secrets.SSH_PRIVATE_KEY != '' &&
        secrets.PROJECT_PATH != '' &&
        secrets.PROJECT_NAME != '' &&
        secrets.BOT_TOKEN != '' &&
        secrets.TRAEFIK_NETWORK != ''
      }}
    steps:
      - name: Validate required secrets
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
          PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          TRAEFIK_NETWORK: ${{ secrets.TRAEFIK_NETWORK }}
        run: |
          set -euo pipefail
          missing=0
          for key in SERVER_HOST SERVER_USER SSH_PRIVATE_KEY PROJECT_PATH PROJECT_NAME BOT_TOKEN TRAEFIK_NETWORK; do
            if [ -z "${!key}" ]; then
              echo "Missing required secret: $key" >&2
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            git pull origin main
            # Create/Update .env from secrets
            echo "PROJECT_NAME=${{ secrets.PROJECT_NAME }}" > .env
            echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> .env
            echo "DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}" >> .env
            echo "TRAEFIK_NETWORK=${{ secrets.TRAEFIK_NETWORK }}" >> .env
            echo "TRAEFIK_ENABLE=${{ secrets.TRAEFIK_ENABLE }}" >> .env
            
            docker compose up -d --build
            docker image prune -f
